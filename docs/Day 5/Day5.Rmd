---
title: "Day 5 Notebook"
output: html_notebook
---
```{r setup, include=FALSE}
library(knitr)
library(dplyr)
library(stringr)
library(tidyverse)
library(igraph)
library(ggplot2)
library(rgl)
library(ggraph)
library(readr)
options(scipen = 999)
```

This takes a lot of set up for the data, but once it is set up, it works so quickly (my first successful solution was brute force.  Solving part 2 took over an hour.  It worked, but it was literally an hour.) I re-did part 1 using the much faster version of part 2.  So, no, this is not how I did part 1 in the first place.

Start with grabbing the first line for the seeds

```{r}
### Read in the seeds. Vector for the seed input
seedinput <- read_lines("Day5Sample.txt",n_max=1)
seedinput <- str_split_i(seedinput,": ",2)
seedinput <- as.numeric(unlist(str_split(seedinput," ")))
```


Then read in the almanacs.  They're brought in, separated by map type, changed to an easier to use format, and ordered according to the lowest starting value.

```{r}
### Read in the almanacs
almanacs <- read_lines("Day5Sample.txt",skip=2)
make_almanac <- function(y){
  lapply(y,function(x){
  x<-unlist(str_split(x," "))
  x<-as.numeric(x)
  x})}
### use the blank lines to deliniate between almanacs
blanklines<-which(almanacs=="")
### 
seed_to_soil <- make_almanac(lapply(almanacs[2:(blanklines[1]-1)],function(x){x}))
soil_to_fertilizer <- make_almanac(lapply(almanacs[(blanklines[1]+2):(blanklines[2]-1)],function(x){x}))
fertilizer_to_water <- make_almanac(lapply(almanacs[(blanklines[2]+2):(blanklines[3]-1)],function(x){x}))
water_to_light <-make_almanac(lapply(almanacs[(blanklines[3]+2):(blanklines[4]-1)],function(x){x}))
light_to_temperature<-make_almanac(lapply(almanacs[(blanklines[4]+2):(blanklines[5]-1)],function(x){x}))
temperature_to_humidity<-make_almanac(lapply(almanacs[(blanklines[5]+2):(blanklines[6]-1)],function(x){x}))
humidity_to_location<-make_almanac(lapply(almanacs[(blanklines[6]+2):length(almanacs)],function(x){x}))
```

the almanacs start in form (destination start, source start, source range length).  That is harder to work with (for me at least). plain_almanac() changes them to (source start, source end, offset)

```{r}
plain_almanac<-function(alm){outalm<-c(alm[2],alm[2]+alm[3]-1,alm[1]-alm[2])}

seed_to_soil  <- lapply(seed_to_soil,plain_almanac)
soil_to_fertilizer  <- lapply(soil_to_fertilizer,plain_almanac)
fertilizer_to_water  <- lapply(fertilizer_to_water,plain_almanac)
water_to_light  <- lapply(water_to_light,plain_almanac)
light_to_temperature  <- lapply(light_to_temperature,plain_almanac)
temperature_to_humidity  <- lapply(temperature_to_humidity,plain_almanac)
humidity_to_location  <- lapply(humidity_to_location,plain_almanac)
```

finally, the almanacs are ordered so the lowest maps are first

```{r}
order_almanac <-function(almlist){
  firstnums<-c()
  for(i in 1:length(almlist)){
    firstnums<-c(firstnums,almlist[[i]][1])}
  outlist <- almlist[order(firstnums)]}

seed_to_soil  <- order_almanac(seed_to_soil)
soil_to_fertilizer  <- order_almanac(soil_to_fertilizer)
fertilizer_to_water  <- order_almanac(fertilizer_to_water)
water_to_light  <- order_almanac(water_to_light)
light_to_temperature  <- order_almanac(light_to_temperature)
temperature_to_humidity  <- order_almanac(temperature_to_humidity)
humidity_to_location  <- order_almanac(humidity_to_location)
```

## Part 1

For part 1, take seed types and push them through the various maps to find the locations that they can be planted in. (Because part 2 will use seed ranges, part 1 will be done as though it were a range of a single seed)

So, creating two functions - evlrng() takes a range and an almanac and returns the mapping. The almanac sections never overlap, and it's a straightforward offset, so there is no real cause for concern.  However, there are a ton of test cases to make sure it works

```{r}
evlrng<-function(rng,almn){
  dothis<-rng
  i<-1
  out<-c()
  while(i<=length(almn)){
    thisalm <- almn[[i]]
      ## if both in front of the section, exit. There is else to transform
    if(dothis[1]<thisalm[1]&dothis[2]<thisalm[1]){
      i<-length(almn)+1
      ## if the range front is in front of the almanac section
      ## add the range-almanac to the outlist, redo with the other part of the range and the same almanac section 
    }else if(dothis[1]<thisalm[1]&dothis[2]>=thisalm[1]){
      out<-append(out,list(c(dothis[1],thisalm[1]-1)))
      dothis<-c(thisalm[1],dothis[2])
      ## if the range is entirely within the almanac section, transform and end the while
    }else if(dothis[1]>=thisalm[1]&dothis[2]<=thisalm[2]){
      dothis<-dothis+thisalm[3]
      i<-length(almn)+1
      ## if the range front is inside, but the back is outside, transform the interior part
      ## update range, and move to the next almanac section
    }else if(dothis[1]>=thisalm[1]&dothis[1]<=thisalm[2]&dothis[2]>thisalm[2]){
      out<-append(out,list(c((dothis[1]+thisalm[3]),(thisalm[2]+thisalm[3]))))
      dothis<-c((thisalm[2]+1),dothis[2])
      i<-i+1
      ## if the range front is after the almanac section, move to the next almanac section
      }else if(dothis[1]>thisalm[2]){
        i<-i+1}else{cat("something went wrong")}}
  out<-append(out,list(dothis))
  out}

#testal <- list(c(10,20,100),c(30,40,200))
#outside
#evlrng(c(5,8),testal) # 5,8
#evlrng(c(25,28),testal) # 25,28
#evlrng(c(45,48),testal) # 45,48
#inside
#evlrng(c(15,18),testal) # 115,118
#evlrng(c(35,38),testal) # 235,238
#aroundfirst
#evlrng(c(5,25),testal) # 5,9 110,120 21,25
#aroundsecond
#evlrng(c(25,45),testal) # 25,29 230,240 41,45
#aroundboth
#evlrng(c(5,45),testal) # 5,9 110,120 21,29 230,240 41,45
#edges
#evlrng(c(5,10),testal) # 5,9 110,110
#evlrng(c(10,15),testal) # 110,115
#evlrng(c(15,20),testal) # 115,120
#evlrng(c(20,25),testal) # 120,120 21,25
#evlrng(c(25,30),testal) # 25,29 230,230
#evlrng(c(30,35),testal) # 230,235
#evlrng(c(35,40),testal) # 235,240 
#evlrng(c(40,45),testal) # 240,240 41,45
##loops
#evlrng(c(5,35),testal) # 5,9 110,120 21,29 230,235
#evlrng(c(15,45),testal) # 115,120 21,29 230,240 41,45
#evlrng(c(15,35),testal) # 115,120 21,29 230,235
##singles
#evlrng(c(5,5),testal) # 5,5
#evlrng(c(10,10),testal) # 110,110
#evlrng(c(15,15),testal) # 115,115
#evlrng(c(20,20),testal) # 120,120
#evlrng(c(25,25),testal) # 25,25
#evlrng(c(30,30),testal) # 230,230
#evlrng(c(35,35),testal) # 235,235
#evlrng(c(40,40),testal) # 240,240
#evlrng(c(45,45),testal) # 45,45

```


And a second function that applies the almanacs in order from seed to location - s2lr()
```{r}
s2lr <- function(x){
  tosoil <- unlist(lapply(x,function(x){evlrng(x,seed_to_soil)}),recursive=FALSE)
  tofertilizer <- unlist(lapply(tosoil,function(x){evlrng(x,soil_to_fertilizer)}),recursive=FALSE)
  towater <- unlist(lapply(tofertilizer,function(x){evlrng(x,fertilizer_to_water)}),recursive=FALSE)
  tolight <- unlist(lapply(towater,function(x){evlrng(x,water_to_light)}),recursive=FALSE)
  totemperature <- unlist(lapply(tolight,function(x){evlrng(x,light_to_temperature)}),recursive=FALSE)
  tohumidity <- unlist(lapply(totemperature,function(x){evlrng(x,temperature_to_humidity)}),recursive=FALSE)
  tolocation <- unlist(lapply(tohumidity,function(x){evlrng(x,humidity_to_location)}),recursive=FALSE)
  tolocation}
```

For part 1, we take our seeds, change them into ranges
```{r}
part1ranges<-c()
for(i in 1:length(seedinput)){
  part1ranges<-append(part1ranges,list(c(seedinput[i],seedinput[i])))
}
part1ranges

p1outs<-s2lr(part1ranges)
p1outs

part1<-c()
for(i in 1:length(p1outs)){
  part1<-c(part1,p1outs[[i]][1])}
part1<-min(part1)
part1
```

## Part 2
For part 2, we actually use the seedlist as a range. 

```{r}
part2ranges<-c()
for(i in seq(1,length(seedinput),2) ){
  st<-seedinput[i]
  fi<-seedinput[i+1]
  rng <- c(st,st+fi)
  part2ranges <- append(part2ranges,list(rng))}

p2outs<-s2lr(part2ranges)
p2outs

part2<-c()
for(i in 1:length(p2outs)){
  part2<-c(part2,p2outs[[i]][1])}
part2<-min(part2)
part2
```


"Single" function (that starts with the seed list & transformed almanacs and the two helper functions)


```{r}
### Input needs to be seedinput
day5answers<-function(seeds){
  ## create part 1 ranges
  part1ranges<-c()
  for(i in 1:length(seeds)){
    part1ranges<-append(part1ranges,list(c(seeds[i],seeds[i])))}

  ## run
  p1outs<-s2lr(part1ranges)
  part1<-c()
  for(i in 1:length(p1outs)){
    part1<-c(part1,p1outs[[i]][1])}
  part1<-min(part1)
  
  ## create part 2 ranges
  part2ranges<-c()
  for(i in seq(1,length(seeds),2) ){
    st<-seeds[i]
    fi<-seeds[i+1]
    rng <- c(st,st+fi)
    part2ranges <- append(part2ranges,list(rng))}

  ## run part 2  
  p2outs<-s2lr(part2ranges)
  part2<-c()
  for(i in 1:length(p2outs)){
    part2<-c(part2,p2outs[[i]][1])}
  part2<-min(part2)
  
  return(c(part1,part2))}
```

```{r}
day5<-day5answers(seedinput)
day5
```